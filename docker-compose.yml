version: '3.8'

services:
  qingping-webhook:
    build: .
    container_name: qingping-webhook
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - QINGPING_APP_SECRET=${QINGPING_APP_SECRET}
      - MQTT_BROKER=${MQTT_BROKER:-mosquitto}
      - MQTT_PORT=${MQTT_PORT:-1883}
      - MQTT_CLIENT_ID=${MQTT_CLIENT_ID:-qingping-webhook}
      - MQTT_USERNAME=${MQTT_USERNAME:-}
      - MQTT_PASSWORD=${MQTT_PASSWORD:-}
      - MQTT_TOPIC_PREFIX=${MQTT_TOPIC_PREFIX:-qingPing/device}
      - MAX_TIMESTAMP_DRIFT_SECONDS=${MAX_TIMESTAMP_DRIFT_SECONDS:-300}
      - ENABLE_REPLAY_PROTECTION=${ENABLE_REPLAY_PROTECTION:-true}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      - mosquitto
    networks:
      - qingping-net
    volumes:
      - ./app:/app  # For development - remove in production

  mosquitto:
    image: eclipse-mosquitto:2.0
    container_name: mosquitto
    restart: unless-stopped
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
    networks:
      - qingping-net

networks:
  qingping-net:
    driver: bridge
